<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
"http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd">
<section id="test-install">
  <title>
  Test-install
  </title>

  <section>
    <title>
    Definition
    </title>

    <para>
    The <emphasis>test-install</emphasis> top-level element supports automated
    installation testing. The test-install element is based on the Deployment
    Elements Common Model.  See <xref
    linkend="deployment-elements-common-model"/> for a complete description of
    syntax, macros, attributes and elements.
    </para>

    <para>
    Deploy accomplishes installation testing using deployment scripts
    described in the Common Model. Should any of the scripts fail to complete
    successfully, Deploy halts processing prior to running the
    <emphasis>test-update</emphasis> and <emphasis>publish</emphasis> events.
    </para>

    <para>
    Because its focus is on installation testing, the test-install event
    attempts to perform a clean client installation each time changes
    changes occur to repository content, to the kickstart file, or to 
    installation scripts.
    </para>

    <para>
    <emphasis>Test-install</emphasis> is an optional element.
    </para>

  </section>

  <section id="test-install-examples">
    <title>
    Examples
    </title>

    <para>
    The following examples configure Deploy to perform a test
    install to a local virtual machine. See the <emphasis>Deploy User
    Manual</emphasis> for information on configuring the build machine to
    support virtual machine installations.
    </para>

    <para>
    This example makes use of two files:
    
    <itemizedlist>
    <listitem><para>
    The main repository definition containing a
    <emphasis>test-install</emphasis> element.
    </para></listitem>

    <listitem>
    <para>
    A template for deploying systems to local virtual machines. The template
    file is located in the templates folder as
    <filename>libvirt/test-install.xml</filename>.
    </para>
    </listitem>
    
    </itemizedlist>
    </para>

    <section>
    <title>test-install element</title>

    <para>
    This test-install element accomplishes the following:

    <itemizedlist>
    <listitem><para>
    Sets a macro indicating that the test-install machine should be deleted
    once test-install completes successfully. Deleting the test-install machine
    is useful once the system is in maintenance mode, as it preserves hard
    drive space and system resources on the build machine.
    </para>
    </listitem>

    <listitem>
    <para>
    Uses XInclude to include the libvirt <filename>test-install.xml</filename>
    deployment template.
    </para>
    </listitem>
    </itemizedlist>
    </para>

    <programlisting>
&lt;test-install>
  &lt;macro id='test-install-post-delete'>true&lt;/macro>
  &lt;xi:include href="%{templates-dir}/%{norm-os}/libvirt/test-install.xml" xpointer="xpointer(./*)"/>
&lt;/test-install></programlisting>
    </section>

    <section id="test-install.xml">
    <title>test-install.xml template</title>

    <para>
    The libvirt <filename>test-install.xml</filename> template, shown below,
    provides the configuration necessary to deploy and maintain a local virtual
    machine. The template in turn makes use of the
    <filename>deploy-base.xml</filename> template, which is used across
    test-install, test-update and publish modules. In addition, it provides
    scripts for testing removal of custom packages, and for conditionally
    deleting the test system after successful test installation. See <xref
    linkend='templates'/> for information on locating and using templates.
    </para>

    <programlisting><xi:include href='../../../../../share/deploy/templates/el6/libvirt/test-install.xml' parse="text" xmlns:xi="http://www.w3.org/2001/XInclude"/></programlisting>
    </section>

  </section>

</section>
