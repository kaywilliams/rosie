<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
"http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd">
<section id="config-rpm"
         xreflabel="config-rpm"
         xmlns:xi="http://www.w3.org/2001/XInclude">
  <title>
  Config-rpm (optional)
  </title>

  <section>
    <title>
    Definition
    </title>

    <para>
    Creates an RPM used to install and update solution-specific configuration on
    the client machine.  The RPM is named:
    </para>

    <synopsis>%{name}-config</synopsis> 
    
    <para>
    See the <emphasis>main/name</emphasis> element for information on
    <emphasis>%{name}</emphasis>.
    </para>

    <para>
    The config-rpm completes three primary functions.
    </para>
    
    <itemizedlist>
    <listitem>
    It installs user-provided configuration files specified via
    <emphasis>config-rpm/files</emphasis> elements. 
    </listitem>
    
    <listitem>
    It runs user-provided scripts specified via
    <emphasis>config-rpm/script</emphasis> and
    <emphasis>config-rpm/trigger</emphasis> elements.
    </listitem>

    <listitem>
    It places copies of user-provided scripts in the
    <filename>/etc/sysconfig/centosstudio/%{name}</filename> folder on
    installed client machines. This assists with troubleshooting "scriptlet
    failed" errors during config-rpm installation and updates.
    Scripts are named with the prefix <varname>config-</varname> followed by
    the script type, e.g. <filename>config-post-script</filename>. Triggers
    are similarly named, but they also include the name provided in the
    <emphasis>@package</emphasis> attribute, e.g.
    <filename>config-triggerin-drupal-script</filename>. See the
    <emphasis>CentOS Studio User Guide</emphasis> for more information on
    testing and troubleshooting client machine installation and updates.
    </listitem>
    </itemizedlist>

    <para>
    The config-rpm element is ignored if <xref linkend="main-type"/> is set to
    "component".
    </para>

  </section>

  <section>
    <title>
    Syntax
    </title>

    <programlisting>
[&lt;config-rpm&gt;
  [&lt;requires&gt;CAPABILITY&lt;/requires&gt;]*
  [&lt;obsoletes&gt;CAPABILITY&lt;/obsoletes&gt;]*

  [&lt;files [destdir=PATH] [destname=BASENAME] [mode=MODE]
          [content=("file"|"text")]&gt;
    (PATH|TEXT)
   &lt;/files&gt;]*

  [&lt;script type=("post"|"pre"|"preun"|"postun"|"verifyscript")&gt;
    TEXT
   &lt;/script&gt;]*

  [&lt;trigger package=CAPABILITY type=("triggerin"|"triggerun"|"triggerpostun")
           [interpreter=PATH]&gt;
    TEXT
   &lt;/trigger&gt;]*
&lt;/config-rpm&gt;]
    </programlisting>
  </section>

  <section>
    <title>
    Elements
    </title>

    <variablelist>
    <varlistentry id="config-rpm-requires"
                  xreflabel="config-rpm/requires">
      <term>
      requires
      </term>

      <listitem>
      <para>
      Specifies a <varname>CAPABILITY</varname> that must be available on
      client machines prior to installation of the config-rpm. Capabilities are
      provided by RPM packages. They can be specified as the name of a package,
      or as a file or virtual capability provided by one or more packages.
      </para>

      <para>
      The <emphasis>requires</emphasis> element can occur zero or more times
      </para>

      <para>
      Capabilities have the following syntax:
      <programlisting>
capability [ comparison_operator  version ]
      </programlisting></para>

      <para>
      Comparison operators can be one of the following. Note that "&gt;"
      and "&lt;" characters must be escaped as shown below, as these characters
      have special meaning in XML documents.
      <simplelist type='horiz' columns='2'>
      <member><emphasis role='strong'>Operator</emphasis></member>
      <member><emphasis role='strong'>Meaning</emphasis></member>
      <member>&amp;gt;</member><member>greater than</member>
      <member>&amp;lt;</member><member>less than</member>
      <member>=</member><member>equal</member>
      <member>&amp;gt;=</member><member>greater than or equal</member>
      <member>&amp;lt;=</member><member>less than or equal</member>
      </simplelist>
      </para>

      <para>
      Following are example <emphasis>requires</emphasis> elements.
      <programlisting>
&lt;requires&gt;samba&lt;/requires&gt;
&lt;requires&gt;samba &amp;gt; 3.0&lt;/requires&gt; &lt;!-- samba > 3.0 --&gt;
&lt;requires&gt;config(samba)&lt;/requires&gt;
&lt;requires&gt;shadow_copy.so&lt;/requires&gt;
      </programlisting></para>

      <note>
      <para>
      You can view the capabilities provided by a package using the
      <command>rpm</command> command. 
      <programlisting>
# list capabilities of an installed package
rpm -q --provides samba 

# list capabilities of a file on disk
rpm -qp --provides samba-3.0.33-3.29.el5_7.4.i386.rpm
      </programlisting>
      </para>
      </note>

      </listitem>
    </varlistentry>

    <varlistentry id="config-rpm-obsoletes"
                  xreflabel="config-rpm/obsoletes">
      <term>
      obsoletes
      </term>

      <listitem>
      <para>
      Specifies a <varname>CAPABILITY</varname>, typically an RPM package, that
      must be removed from the client machines prior to installation of the
      config-rpm. Useful for removing conflicting or undesirable software from
      client machines, particularly for machines without the YUM sync plugin.
      See the <xref linkend="config-rpm-requires"/> element above for more
      information on specifying capabilities. See also the <xref
      linkend="release-rpm-updates"/> element for information on the YUM sync
      plugin.
      </para>

      <para>
      Can occur zero or more times.
      </para>

      <para>
      Examples
      </para>

      <informalexample>
      <programlisting>
&lt;obsoletes&gt;kernel &amp;lt; 2.4.1&lt;/obsoletes&gt; &lt;!-- kernel &lt; 2.4.1 --&gt;
&lt;obsoletes&gt;X11R6-contrib&lt;/obsoletes&gt;
      </programlisting>
      </informalexample>

      </listitem>
    </varlistentry>

    <varlistentry id="config-rpm-files"
                  xreflabel="config-rpm/files">
      <term>
      files
      </term>

      <listitem>
      <para>
      Specifies a file or folder containing files to install to client
      machines. Can occur zero or more times.
      </para>

      <para>
      Accepts four attributes:
      <emphasis>@content</emphasis>,
      <emphasis>@destdir</emphasis>,
      <emphasis>@destname</emphasis>, and
      <emphasis>@mode</emphasis>.
      </para>

      <para>
      <emphasis>@content</emphasis>: Accepts either "file" or "text".  
      When <emphasis>content</emphasis> is
      "file", the element's text value is treated as a
      <varname>PATH</varname> to a file, whereas when it is "text", the
      element's text value is interpreted as the raw text to use for creating
      a file with the name specified using the @destname attribute.
      The default value is "file".
      </para>

      <para>
      <emphasis>@destdir</emphasis>: See the path-like attribute
      <emphasis><xref linkend="destdir" /></emphasis>. Controls the
      location to which this file should be installed on client
      machines. The default value is
      <filename>/etc/sysconfig/centosstudio/%{name}/files</filename>.
      </para>

      <para>
      <emphasis>@destname</emphasis>: See the path-like attribute
      <emphasis><xref linkend="destname" /></emphasis>. If
      <emphasis>@content</emphasis> is "text", this attribute is required.
      </para>

      <para>
      <emphasis>@mode</emphasis>: See the path-like attribute
      <emphasis><xref linkend="mode" /></emphasis>.
      </para>

      <para>See <xref linkend="path-like-element"/> for more information.</para>
    </listitem>
    </varlistentry>

    <varlistentry id="config-rpm-script"
                  xreflabel="config-rpm/script">
      <term>
      script
      </term>

      <listitem>
      <para>
      Specifies a script to run during RPM installation or removal. Can occur
      zero or more times.
      </para>

      <para>
      Accepts one attribute,
      <emphasis>@type</emphasis>.
      </para>

      <para>
      <emphasis>@type</emphasis>: Specifies the type of RPM script; must
      be one of "pre", "post", "preun", "postun" or "verifyscript". This
      attribute is required. For more information on defining scripts in
      RPM spec files, see the Fedora project's <emphasis>"RPM Guide"</emphasis>
      by Eric Foster-Johnson.
      </para>

      <para>Provides a runtime variable <emphasis>$changed</emphasis> for use
      by user-provided scripts. The <emphasis>$changed</emphasis> variable
      contains a string-separated list of files, currently or previously
      installed by the configuration package, that meet one or more of the
      following criteria:

      <itemizedlist>
      <listitem>added since the last configuration package update</listitem>
      <listitem>modified since the last configuration package update</listitem>
      <listitem>differs from the the file on disk</listitem>
      <listitem>removed since the last configuration package update</listitem>
      </itemizedlist>

      The space-separated list of files within the
      <emphasis>$changed</emphasis> variable also has leading and following
      space characters, for easier pattern matching. See the examples section
      for a script that makes use of the <emphasis>$changed</emphasis>
      variable.
      </para>

      </listitem>
    </varlistentry>

    <varlistentry id="config-rpm-trigger"
                  xreflabel="config-rpm/trigger">
      <term>
      trigger
      </term>

      <listitem>
      <para>
      Specifies a script to run during RPM installation and removal. Can occur
      zero or more times.
      </para>

      <para>
      Accepts three attributes:
      <emphasis>@interpreter</emphasis>,
      <emphasis>@package</emphasis>, and
      <emphasis>@type</emphasis>.
      </para>

      <para>
      <emphasis>@interpreter</emphasis>: The <varname>PATH</varname> to
      the executable language interpreter to use when running the trigger
      script. The default value is <filename>/bin/sh</filename>.
      </para>

      <para>
      <emphasis>@package</emphasis>: The name of the RPM this script
      triggers on.  This attribute is required. See Also the
      <emphasis>@type</emphasis> attribute.
      </para>

      <para>
      <emphasis>@type</emphasis>: Specifies the type of RPM trigger
      script; must be one of "triggerin", "triggerun", or "triggerpostun".
      This attribute is required. For more information on defining trigger
      scripts in RPM spec files, see the Fedora project's
      <emphasis>"RPM Guide"</emphasis> by Eric Foster-Johnson. See Also the
      <emphasis>@package</emphasis>
      attribute.
      </para>
      </listitem>
    </varlistentry>
    </variablelist>
  </section>

  <section>
    <title>
    Examples
    </title>

    <informalexample>
    <programlisting>
&lt;config-rpm&gt;
  &lt;!-- put smb.conf in /etc/samba on the client machine --&gt;
  &lt;files destdir="/etc/samba"&gt;
    smb.conf
  &lt;/files&gt;

  &lt;!-- rename and change mode of aliases.txt --&gt;
  &lt;files destdir="/etc" destname="aliases" mode="0600"&gt;
    aliases.txt
  &lt;/files&gt;

  &lt;!-- create /etc/hosts using the supplied text --&gt;
  &lt;files destdir="/etc" destname="hosts" content="text"&gt;
# Do not remove the following line, or various programs
# that require network functionality will fail.
127.0.0.1   localhost.localdomain localhost
::1         localhost.localdomain localhost
  &lt;/files&gt;

  &lt;!-- required packages --&gt;
  &lt;requires&gt;samba&lt;/requires&gt;
  &lt;requires&gt;samba-common&lt;/requires&gt;

  &lt;!-- add a RPM %post script --&gt;
  &lt;script type="post"&gt;
if [[ $changed = *\ /etc/samba/smb.conf\ * ]] ; then
      service smb restart
fi
chkconfig smb on
  &lt;/script&gt;

  &lt;!-- add a RPM %triggerin script that triggers on samba --&gt;
  &lt;trigger package="samba" type="triggerin"&gt;
    scripts/smb-triggerin.sh
  &lt;/trigger&gt;
&lt;/config-rpm&gt;
    </programlisting>
    </informalexample>
  </section>

  <section>
    <title>
    See Also
    </title>

    <para>
    <varname><xref linkend="content-basename" /></varname>,
    <varname><xref linkend="content-package" /></varname>,
    <varname><xref linkend="content-path" /></varname>,
    <varname><xref linkend="content-text" /></varname>,
    <xref linkend="path-like-element" />,
    <emphasis role="strong"><xref linkend="repos" /></emphasis>
    </para>
  </section>
</section>
