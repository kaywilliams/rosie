<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<section id="installing-physical-and-virtual-clients" 
         xreflabel="Installing Physical and Virtual Clients">
  <title>Installing Physical and Virtual Clients</title>

  <para>Deployment to a client machine is the next step. Because 
  <application class="software">OpenProvision</application> creates
  system repositories in a standard operating system format, client machines
  can be deployed using the same tools and methods as used for 
  <application class="software">Red Hat Enterprise Linux</application> and
  <application class="software">CentOS</application>.</para> 

  <para>For the samba-server example, we will discuss two installation methods. In the first method, you will install to a physical machine using a bootable CD or DVD. In the second, you will install to a virtual machine.</para>

  <para>The methods discussed below are only two of several possible methods for
  installing your system repository to physical or virtual client machines. See the   
  <emphasis>Red Hat Enterprise Linux 5 Installation Guide</emphasis> and 
  <emphasis>Red Hat Enterprise Linux 5 Virtualization Guide</emphasis> for 
  additional methods and complete information.</para> 

  <section><title>Installing to a Physical Machine</title>
  
  <para>In this method, you will use a network install image (<filename>boot.iso</filename>)
  to create an installation CD or DVD. To start the installation, you will boot
  the client machine using the CD/DVD. The installer program contained on the
  CD/DVD will then use the network to download files from the system repository URL
  to complete the installation. To complete this example, you must have
  configured the build machine as a web server, as described in 
  <xref linkend="configuring-a-build-machine"/> </para>

    <section>
      <title>Creating boot media</title>
      <para>After <application class="software">OpenProvision</application>
      completes the build, you  will find your system repository in a folder beneath
      the <filename class="directory">/var/www/html/system_repos</filename> 
      default directory on the download server. The folder name will be
      the system repository <varname>$ID</varname>, e.g.
      <filename>samba-server-5-i386</filename>.</para>

      <para>To install to a client machine, you burn a boot image to a separate
      media. For this example, burn the <filename>boot.iso</filename> image 
      (found in the <filename class="directory">/os/images</filename> folder 
      below the <filename class="directory">/system_repos/samba-server-5-i386
      </filename> folder, above) to a CD or DVD.</para>

      <para>To burn the image, one option is to run the
      <command>cdrecord</command> command from the <filename
      class="directory">/os/images</filename> folder as illustrated below. Note
      the scanbus number sequence, then record the ISO image onto a CD or DVD
      and label the media, including the number sequence. The number sequence,
      e.g. 1,0,0, may differ from machine to machine.</para>

      <para><informalexample>
          <programlisting># cdrecord -scanbus -dev=ATA
# cdrecord -v -dao dev=ATA:1,0,0 boot.iso</programlisting>
        </informalexample></para>
    </section>

    <section>
      <title>Booting a client machine</title>
      <para>Now you are ready to create your client. Place the boot media into the CD/DVD drive of the client machine. Now restart the client, booting from the CD or DVD. The boot process will load an installation program, or <emphasis>installer</emphasis> from the CD or DVD into system memory. The installer will complete the installation, retrieving additional content over the network from the <xref linkend="download-location"/>. When the installation successfully completes, the client system will reboot and display a login prompt. You can check the <filename>sys.log</filename> file for installation and boot process log information.</para>
    </section>
  </section>

  <section><title>Installing to a Virtual Machine</title>

  <para>Machine virtualization is a relatively new technology with many possibilities for simplifying system administration. In the samba-server example, we will use machine virtualization to test client installation, quickly and easily, without requiring a separate physical client machine, or the creation of physical boot media media (e.g. a CD/DVD disc as in the prior method). System testing using virtual machines is convenient, even when your target clients are physical machines, as it allows you to work more efficiently during the highly iterative development and testing process. To use the method described below, you must have previously configured the build machine to meet exacting hardware, operating system, and configuration requirements. See the section on <xref linkend="configuring-a-build-machine"/> for more information.</para>

  <para>Once you have configured, and rebooted, your machine as described under <emphasis>Configuring a Build Machine</emphasis>, you are ready to install a new virtual machine using either the <command>virt-manager</command> or <command>virt-install</command> commands. For best results, complete the process one time using virt-manager. Virt-manager provides a graphical user interface that will aid your understanding of the process and help you to ensure that your machine is configured correctly. Once you are familiar with the process, you may find it more efficient to use the command-line utility, <application type="software">virt-install</application>, to complete additional virtual machine installations.</para>

    <section><title>Using virt-manager</title>
      <para>Virt-manager provides a graphical user interface for creating and managing virtual machines. For the samba-server example, create a new virtual machine using virt-manager as follows:</para>

      <orderedlist>
        <listitem>As the root user, start virt-manager by typing "<userinput>virt-manager &amp;</userinput>" at the command prompt.</listitem>
        <listitem>Click on the row beginning with the name "localhost". This will enable the "New" button in the lower right corner of the dialog. If the new button is not available, try exiting virt-manager, switching to the root user, and restarting.</listitem>
        <listitem>Click the "New" button. This brings up a dialog titled "Create a new virtual machine". Click the "Forward" button.</listitem>
        <listitem>In the "Virtual Machine Name" panel, type <userinput>samba-server</userinput> as the machine name. Click the "Forward" button.</listitem>
        <listitem>In the "Virtualization Method" panel, ensure that the "Fully Virtualized" option is active and selected. If it is greyed out, your machine may not support kernel virtualization extensions, or it may not be configured correctly. Return to the section on <xref linkend="configuring-a-build-machine"/> for hardware and software requirements, and machine configuration instructions. Be sure to reboot the machine after following all instructions. If the "Fully Virtualized" option is active and selected, click the "Forward" button.</listitem>
        <listitem>In the "Installation Method" panel, click the "Network Install Tree" option. Click "Forward".</listitem>
        <listitem>In the "Installation Source" panel, type "<userinput>http://$IP/system_repos/samba-server-5-i386/os</userinput>", where $IP is the IP address of the build machine, locatable by typing <userinput>ifconfig eth0</userinput> at a command prompt on the build machine.  Alternatively, if your build machine is locatable via DNS, you can enter the Fully Qualified Domain Name (FQDN) of the build machine in place of the IP address. Note, however, that you cannot enter a hostname (e.g. "myhost") that is not a FQDN (e.g. "myhost.mycompany.com"), as domain searching is not currently supported when using virtual networks. Doing so will result in an error later in the installation process ("Unable to retrieve http://myhost/system_repos/samba-server/os/images/stage2.img"). Click "Forward".</listitem>
        <listitem>In the "Storage" panel, ensure the "File (disk image)" option is selected and the value is set to <userinput>/var/lib/libvirt/images/samba-server.img</userinput>. In subsequent installations (after deleting an existing virtual machine - see <xref linkend="deleting-a-virtual-machine"/>) virt-manager will attempt to automatically increment the image name, e.g. to <userinput>/var/lib/libvirt/images/samba-server-1.img</userinput>. To preserve disk space on the build machine, you should either reset the image name to <userinput>samba-server.img</userinput>, or make it a practice to clean out the /var/lib/libvirt/images folder on a regular basis. Click "Forward".</listitem>
        <listitem>In the remaining panels, accept the default values and continue to click "Forward".</listitem>
        <listitem>Click "Finish" to start the installation. If you get an error "Unable to retrieve http://$IP/system_repos/samba-server-5-i386/os/stage2.img" during installation, check that 1) you have typed the url correctly, 2) you have provided an IP address or FQDN in the host portion of the URL and 3) the httpd service is running on your build machine and you have allowed port 80 traffic through the machine's firewall (see <xref linkend="configuring-a-build-machine"/>).</listitem>
        <listitem>Once installation completes, choose "Reboot".</listitem>
        <listitem>In the resulting dialog, click "Run" to start the machine and test that it functions as expected.</listitem>
      </orderedlist>

    </section>

    <section><title>Using virt-install</title>
      <para>The <command>virt-install</command> utility provides a command-line user interface for installing virtual machines. For the samba-server example, use virt-install to create a new virtual machine as follows. You must be the root user.</para>

        <para><informalexample><programlisting>
# virt-install --accelerate --hvm --connect qemu:///system \
	--network network:default \
	--name samba-server --ram=512\
	--file=/var/lib/libvirt/images/samba-server.img \
	--file-size=4 --vnc --location=http://$IP/system_repos/samba-server-5-i386/os
        </programlisting></informalexample></para>

      <para>The variable $IP above indicates the IP address of the build machine, locatable by typing <userinput>ipconfig eth0</userinput> at the command line.</para>

      <para>See the section on virt-manager above for help with related common problems and error messages</para>
    </section>

    <section id="deleting-a-virtual-machine" xreflabel="Deleting a virtual machine"><title>Deleting a virtual machine</title>

      <para>While developing a new system repository, you may wish to reuse the same virtual-machine name for testing multiple iterations of the same system. You can do this using <command>virt-manager</command> as follows:</para>

      <itemizedlist>
        <listitem>From the virt-manager graphical user interface, click on the line beginning "samba-server".</listitem>
        <listitem>If the machine is currently running, choose Shutdown and/or Force Off.</listitem>
        <listitem>Then click the "Delete" button in the lower right corner of the dialog.</listitem>
      </itemizedlist>
    </section>

  </section>

  <section><title>Verifying the Installation</title>
    <para>One quick test to make sure the install completed correctly, on either
    a physical or virtual client, is
    to verify the contents of the <filename>smb.conf</filename>
    installed on the client machine. It should match the one provided in the
    system definition.</para>

    <para>Congratulations! You now have a Samba server installed on a CentOS 5
    client machine.</para>
  </section>

</section>
