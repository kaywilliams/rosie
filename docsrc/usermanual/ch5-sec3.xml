<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<section id="using-scripts-and-triggers" xreflabel="Using Scripts and Triggers">
  <title>Using Scripts and Triggers</title>

  <para>Scripts and triggers enable you to control your client's environment
  to a great degree. To include these in your system repository, use the
  <emphasis>config</emphasis> element in your
  <filename>samba-server.definition</filename> file.</para>

  <section>
  <title>Running Scripts when the Configuration Package is Installed or Uninstalled</title>

  <para>The program that installs RPMs on the client machine
  actually runs scripts depending upon one of several possible situations. Include
  these scripts using <emphasis>config/scripts</emphasis> in your
  system definition. Commonly referred to by their installation script
  markers in an RPM spec file, the scripts execute prior to or following
  installation or uninstallation. See Section 9.4.4 "Defining installation
  scripts," in the Fedora Project's documentation, <ulink
  url="http://docs.fedoraproject.org/drafts/rpm-guide-en/">RPM Guide</ulink>
  by Eric Foster-Johnson. See also 
  <ulink url="http://fedoraproject.org/wiki/Packaging/ScriptletSnippets">
  Fedora Packaging ScriptletSnippets wiki page</ulink> and the 
  <ulink url="http://www.rpm.org/max-rpm-snapshot/">Maximum RPM</ulink>book.

  <para>In the example below, the <emphasis>/script</emphasis> element directs
  the installation program to execute the <filename>smb.script</filename> file
  after installing the RPM.</para>

  <para><informalexample>
      <programlisting>&lt;!-- start samba daemon at init levels 3 and 5  --&gt;
&lt;script type="post" content="filename"&gt;
scripts/smb.script
&lt;/script&gt;</programlisting>
    </informalexample></para>

  <para>For the installation to run properly, you will need to create the
  <filename>smb.script</filename> file under a <filename
  class="directory">scripts</filename> directory and include the contents
  below. </para>

  <para><informalexample>
      <programlisting>/sbin/service smb start
/sbin/chkconfig --level 35 smb on</programlisting>
    </informalexample></para>

  </para>

  <section>
  <title>Running Scripts only when Installed Files Change</title>

  <para>You may want to perform certain actions, such as restarting system services, only when specific files change. This increases installation performance of the configuration package, and eliminates unnecessary disruption to previously installed systems. To do this, you can make use of the <emphasis>$changed</emphasis> variable. This variable contains a string-separated list of files to be installed by the configuration package that differ from existing files in the file system, or do not currently exist.</para>

  <para>For example, to restart the web server service (httpd) only when the httpd.conf file changes, the <emphasis>config</emphasis> element in your definition would look as follows:</para>

  <para><informalexample>
      <programlisting>
&lt;config&gt;

&lt;files destdir="/etc/httpd/conf/"&gt;httpd.conf&lt;/files&gt;

&lt;script type="post" content="text"&gt;
  if [[ $changed = */etc/httpd/conf/httpd.conf* ]] ; then
    service httpd restart
  fi
&lt;/script&gt;

&lt;/config&gt;
      </programlisting>
    </informalexample></para>

  </section>

  </section>

  <section>
  <title>Running Scripts when other Packages are Installed or Uninstalled</title>
  <para>You can also use trigger events as in the RPM spec file. The
  installation program will run these scripts based upon various combinations
  of installing, upgrading or removing the target package or your package. See
  Section 10.2 "Setting Triggers," in the Fedora Project's documentation,
  <ulink url="http://docs.fedoraproject.org/drafts/rpm-guide-en/">RPM
  Guide</ulink> by Eric Foster-Johnson for a discussion of the trigger options
  and their implications. To activate these trigger options using OpenProvision,
  include them with the <emphasis>config/trigger</emphasis> element of
  your system definition.</para>

  <para>In the <emphasis>/trigger </emphasis>element example, below, includes
  an <filename>smb.sh</filename> script file to run when the program installs
  the samba package.</para>

  <para><informalexample>
      <programlisting>&lt;!-- run shell script to check if samba-related services are present --&gt;
&lt;trigger package="samba" type="triggerin" content="filename"&gt;
scripts/smb.sh
&lt;/trigger&gt;</programlisting>
    </informalexample></para>

  <para>You will need to create a sample <filename>smb.sh</filename> file and
  store it in the relative location. The contents are below.</para>

  <para><informalexample>
      <programlisting>#!/bin/sh
if test -s /etc/samba/smb.conf; then
 cp smb.conf /etc/samba
# could also run an /etc/init.d script
else
 mkdir /etc/samba
 cp smb.conf /etc/samba
fi </programlisting>
    </informalexample></para>

  </section>


  <para>Scripts and triggers allow you to fine-tune client configuration during installation or removal of the configuration package, or other packages that you specify. </para>
</section>
