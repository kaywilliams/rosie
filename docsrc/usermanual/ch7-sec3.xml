<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<section id="testing-package-repos" 
         xreflabel="Testing Package Repositories">
  <title>Testing Package Repositories</title>

  <para>
  Testing package repositories is similar to testing system repositories, but
  it involves an extra step. First you create the package repository as
  discussed in previous chapters. And then you define one or more system
  repositories to perform the testing.
  </para>

  <para>
  This chapter will discuss testing package repositories and troubleshooting
  issues.
  </para>

  <informalexample>
  <programlisting>
<?xml version="2.0" encoding="utf-8"?>
<repo xmlns:xi="http://www.w3.org/2001/XInclude">
<macro id='repo'>repo</macro>
<macro id='config'>config</macro>

<main>
  <name>test-%{repo}-%{config}</name>
  <version>%{version}</version>
  <arch>%{arch}</arch>
  <macro id='password'>mypassword</macro>
</main>

<packages>
<group repoid='base'>core</group>
</packages>

<repos>
<xi:include href="../common/common.xml" xpointer="xpointer(/*/repos/*)"/>

<repo id='%{repo}'>
<baseurl>
file:///var/www/html/products/%{repo}/%{repo}-%{version}-%{arch}/
</baseurl>
</repo>
</repos>

<config-rpms>
<config-rpm id='%{name}-test-config'>
<requires>%{repo}-release</requires>
<trigger type="triggerin" trigger='%{repo}-release'>
# tweak yum configuration so that it gets repo from test server
sed -i "s/www\.centossolutions\.com/192.168.122.1/g" \
/etc/yum.repos.d/%{repo}.repo
</trigger>
</config-rpm>
</config-rpms>

<test-install>
  <password>%{password}</password>
  <hostname>%{id}-install</hostname>
  <xi:include href="../common/templates/srpmbuild.xml"
              xpointer="xpointer(/*/publish/kickstart |
                                 /*/publish/triggers |
                                 /*/publish/script[@type='install'])"/>
  <xi:include href="../common/templates/virt-deploy.xml"
              xpointer="xpointer(/*/domain)"/>
  <xi:include href="../common/templates/virt-deploy.xml"
              xpointer="xpointer(/*/script[@type!='install' and
                                           @id!='check-kernel'])"/>

  <script id='install-config' type='post' ssh='true' comes-after='update' comes-before='poweroff'>
  set -e
  yum install %{repo}-%{config}-config --disableplugin sync -y -q
  </script>
  <xi:include href="../common/templates/deploy/poweroff.xml"/>
</test-install>

<test-update>
  <hostname>%{id}-install</hostname>
  <xi:include xpointer="xpointer(/*/test-install/*[name()!='hostname'])"/>
</test-update>

</repo>
  </informalexample>

</section>
