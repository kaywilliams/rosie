<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<section id="testing-system-installation" >
  <title>Testing System Installation</title>

  
  <para>
  Deploy enables <emphasis>installation</emphasis> testing using the
  <emphasis>test-install</emphasis> element. As usual, the easiest way 
  to complete this element is using a template, in this case the
  <filename>test-install.xml</filename> template, as shown below:
  </para>

  <informalexample>
  <programlisting>&lt;test-install>
  &lt;macro id='test-install-post-delete>false&lt;/macro>
  &lt;xi:include href="%{templates-dir}/%{norm-os}/libvirt/test-install.xml"
              xpointer="xpointer(./*)"/>
&lt;/test-install></programlisting>
  </informalexample>

  <para>
  When the <constant>test-install</constant> element shown above is present,
  Deploy performs the following tasks:
  </para>

  <itemizedlist>
  <listitem>
  <para>
  Creates a test-install repository in the test-install folder at 
  <filename>/var/www/html/deploy/systems/test-install</filename>, by default.
  </para>
  </listitem>

  <listitem>
  <para>
  Uses scripts in the <filename>test-install.xml</filename> template to install 
  a new virtual machine running on the local system. In our web-server example,
  the hostname will be
  <emphasis>web-server-centos-6-x86-64-test-install</emphasis>. You can connect
  to the virtual machine using SSH as follows:
  </para>

  <programlisting>ssh web-server-centos-6-x86-64-test-install -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null</programlisting>

  <para>
  The <varname>StrictHostKeyChecking</varname> and
  <varname>UserKnownHostsFile</varname> options prevent SSH from checking and
  storing the client host key. This is desirable since test-install machines
  are created and deleted at will, and their keys are not guaranteed to be
  stable.
  </para>
  </listitem>

  <listitem>
  <para>
  Verifies the client machine installation, halting process if an error occurs.
  This allows errors to be resolved prior to publishing changes to the system
  repository. See the <xref linkend='troubleshooting-system-repos'/> section
  for help resolving errors.
  </para>
  </listitem>
  </itemizedlist>
  
  <para>
  During subsequent build cycles, Deploy completes the following:
  </para>

  <itemizedlist>
  <listitem>
  <para>
  Synchronizes any repository changes to the test-install location.
  </para>
  </listitem>

  <listitem>
  <para>
  Determines whether changes have occurred that require retesting installation.
  </para>
  </listitem>

  <listitem>
  <para>
  If so, it deletes the existing machine, and completes the installation and
  verification steps listed above.
  </para>
  </listitem>
  </itemizedlist>

  <para>
  Once development is complete and the system is stable, you may wish to change
  the value of the <varname>test-install-post-delete</varname> macro to
  <constant>true</constant>. This will cause the virtual machine to be deleted
  once testing is complete, freeing up system resources.
  </para>

</section>
