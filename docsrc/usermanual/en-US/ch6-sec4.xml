<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<section id="virtual">
  <title>Virtual/Hosted</title>

  <para>
  Virtual machine and hosted system deployment is another scenario supported by
  Deploy. This scenario covers deployment to a range of hypervisor and
  hosted solutions including VMWare, Hyper-V, KVM, Xen and Amazon Web
  Services. Some virtual machine management solutions support PXE-based
  deployment. If so, PXE deployment is recommended. See the section on <xref
  linkend='enterprise'/> for information on PXE-based deployment.
  </para>

  <para>
  If your virtual machine management solution does not support PXE-based
  deployment, another option is to use Deploy to create virtual machine
  images in the desired format. These images can then be deployed to the
  production environment.
  </para>

  <para>
  To use Deploy for creating virtual machine images, you start with a
  definition as shown in the <xref linkend='smb'/>
  scenario. To this definition you provide an additional
  <emphasis>update</emphasis>-type script to create the virtual machine image.
  Deploy will execute the script each time the repository is updated,
  ensuring that the installation image is always current. See the script element below for an example. 
  </para>

  <para>
  <emphasis role='strong'>Example</emphasis>
  </para>

  <para>
  The example below shows providing a script to create a virtual machine image.
  In this example, we reuse content from the virt-install.xml template to
  create a machine that will run under a KVM hypervisor. Other hypervisor
  systems will provide similar utilities for creating virtual machine images.
  See the documentation for your hypervisor for additional information. We then
  copy the created image to a production location where it can be accessed by
  the virtual machine management solution.
  </para>
  <informalexample>
  <programlisting>&lt;publish>
...
&lt;script id='create-virtual-machine-image' type='update' ssh='false'>
# reuse content from the virt-install.xml template to create the vm image
&lt;include href='%{templates-dir}/%{norm-os}/deploy/deploy.xml'
         xpath='/script/text()'/>

# copy the created image to a production location
rsync -a --delete -e ssh \
"/var/lib/libvirt/images/%{fqdn}.img" \
"user@www.company.com:/vm_images"
&lt;/script>
&lt;/publish>

&lt;/repo></programlisting>
  </informalexample>

</section>

