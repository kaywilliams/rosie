<?xml version="1.0" encoding="utf-8"?>
<root xmlns:xi="http://www.w3.org/2001/XInclude">

<!-- scripts for installing and updating a local virtual machine -->
<trigger-install-script>
#!/bin/bash
INSTALL_INFO=/etc/sysconfig/centosstudio/install_info

FAIL=0

# create function to handle trigger failures
fail () {
FAIL=1
echo "$1 has changed" >&amp;2
}

# include install_info
if [[ -f $INSTALL_INFO ]]; then
  source $INSTALL_INFO
fi

# process triggers
[[ '%{trigger_list}' = ${install_trigger_list} ]] || fail 'trigger_list'
[[ '%{release_rpm}' == ${install_release_rpm} ]] || fail 'release-rpm'
[[ '%{config_rpm}' == ${install_config_rpm} ]] || fail 'config-rpm' 
[[ '%{kickstart}' == ${install_kickstart} ]] || fail 'kickstart'
[[ '%{treeinfo}' == ${install_treeinfo} ]] || fail 'treeinfo'
[[ '%{install_script}' == ${install_install_script} ]] || fail 'install-script'
[[ '%{post_install_script}' == ${install_post_install_script} ]] || fail 'post-install-script'

exit $FAIL
</trigger-install-script>

<activate-script>
#!/usr/bin/python
import libvirt
import sys
connection = libvirt.open('qemu:///system')
try: #vm exists?
  vm = connection.lookupByName('%{hostname}')
except libvirt.libvirtError:
  print "vm does not exist"
  sys.exit(1)
state = vm.state(0)[0]
if state == 1: # vm is active
  sys.exit(0) 
elif state == 3: # vm is paused 
  if vm.resume() == 0: 
    sys.exit(0) #resume succeded
  else:
    print "vm is paused and failed to resume"
    sys.exit(1)
elif vm.create() == 0: # vm is inactive
  sys.exit(0)
else:
  print "vm is inactive and failed to start"
  sys.exit(1)
</activate-script>

<delete-script>
#!/bin/bash
set -e
if [[ `virsh list` = *\ %{hostname}\ * ]]; then virsh destroy %{hostname}; fi
if [[ `virsh list --all` = *\ %{hostname}\ * ]]; then virsh undefine %{hostname}; fi
</delete-script>

<install-script>
#!/bin/bash
virt-install --name %{hostname} --ram 1000 \
             --file /var/lib/libvirt/images/%{hostname}.img \
             --file-size 30 \
             --location %{url} \
             --extra-args "%{boot-options} ks=%{url}/ks.cfg"\
             --noreboot
</install-script>

<post-install-script>
#!/bin/bash
INSTALL_INFO=/etc/sysconfig/centosstudio/install_info

#check install.log for errors
if grep "scriptlet failed" /root/install.log 1>/dev/null ; then
  grep -v "NOKEY" /root/install.log | \
  grep -v "*** FINISHED INSTALLING PACKAGES ***" | \
  grep -v "^Installing "
  exit 1
fi

# create INSTALL_INFO file
echo "
install_trigger_list='%{trigger_list}'
install_release_rpm='%{release_rpm}'
install_config_rpm='%{config_rpm}'
install_kickstart='%{kickstart}'
install_treeinfo='%{treeinfo}'
install_install_script='%{install_script}'
install_post_install_script='%{post_install_script}'
" > $INSTALL_INFO

</post-install-script>

<update-script>
#!/bin/bash
set -e
yum sync -y
if [[ `uname -r` != `rpm -q kernel | sed s/kernel-//` ]] ; then
  echo "running kernel differs from installed - restarting machine"
  shutdown -r now
fi
</update-script>

<post-script>
#!/bin/bash
poweroff
</post-script>

</root>
