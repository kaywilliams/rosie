<?xml version="1.0" encoding="utf-8"?>
<root xmlns:xi="http://www.w3.org/2001/XInclude">

<!-- scripts for installing and updating a local virtual machine -->
<config-rpm>
  <requires>openssh</requires>
  <files destdir='/root/.ssh/' destname="id_rsa.pub">%{ssh-pubfile}</files>
  <script type='post'>
  # set some convenience variables
  sshdir=/root/.ssh
  pubkey=$sshdir/id_rsa.pub
  authkeys=$sshdir/authorized_keys

  # make sshdir if it doesn't exist
  [[ -d $sshdir ]] || mkdir $sshdir 

  # create authorized_keys file if it doesn't exist
  [[ -f $authkeys ]] || touch $authkeys

  # copy id_rsa into authorized keys if it's not there arleady
  [[ `cat $authkeys` == *`cat $pubkey`* ]] || cat $pubkey &gt;&gt; $authkeys
    
  # set permissions
  chmod 700 $sshdir
  chmod 600 $authkeys
  </script>
</config-rpm>

<kickstart>
  <xi:include href='ks.cfg' parse='text'/>
</kickstart>

<trigger>
  <xi:include href='deploy/test-triggers.xml'/>
</trigger>

<activate>
  <xi:include href='deploy/virt-activate.xml'/>
</activate>

<install>
  <xi:include href='deploy/virt-delete.xml'/>
  <xi:include href='deploy/virt-install.xml'/>
</install>

<post-install>
  <xi:include href='deploy/verify-install.xml'/>
  <xi:include href='deploy/save-triggers.xml'/>
</post-install>

<post>
  <xi:include href='deploy/update.xml'/>
  <xi:include href='deploy/check-kernel.xml'/>
</post>

</root>
