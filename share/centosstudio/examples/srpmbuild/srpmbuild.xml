<?xml version="1.0" encoding="utf-8"?>
<repo schema-version="1.0" xmlns:xi="http://www.w3.org/2001/XInclude">

<main>
<name>srpmbuild</name>
<fullname>RPM Build Virtual Machine</fullname>
</main>

<config-rpms>
<!-- ssh configuration -->
<xi:include href="../common/deploy.xml" 
            xpointer="xpointer(/*/config-rpms/*)"/>
</config-rpms>

<publish password='srpmbuild' hostname='%{id}.local'>
<local-dir>/var/www/html/repos/.srpmbuild</local-dir>
<remote-url>http://192.168.122.1/repos/.srpmbuild</remote-url>

<kickstart>
<xi:include href="../common/ks.cfg" parse="text"/>
skipx
</kickstart>

<trigger triggers='kickstart, install-scripts, release-rpm'>
<xi:include href="../common/deploy.xml" 
            xpointer="xpointer(/*/trigger/*)"/>
</trigger>

<install>
<xi:include href="../common/deploy.xml" 
            xpointer="xpointer(/*/install/*[@id='virt-delete'])"/>
<script id='virt-install'>
virt-install --name %{hostname} --ram 1000 \
             --file /var/lib/libvirt/images/%{hostname}.img \
             --file-size 10 \
             --location %{url} \
             --extra-args "lang=en_US keymap=us ip=dhcp noipv6\
               ks=%{url}/ks.cfg"\
             --noreboot
</script>
</install>

<post>
<xi:include href="../common/deploy.xml" 
            xpointer="xpointer(/*/post/*[@id='update'])"/>
<script id='rpmbuild'>
#!/bin/bash
### build and verify rpm packages ###

# install packages required to build the rpm
yum sync -y -q || (echo 'yum sync failed' >&amp;2; exit 1)

# start clean
(set -e
 for d in BUILD SRPMS SPECS SOURCES RPMS; do 
   rm -rf %{build-dir}/$d
   mkdir %{build-dir}/$d
 done)
if [[ $? != 0 ]]; then echo 'setup failed' >&amp;2; exit 1 ; fi

# install srpm
rpm -Uvh --nodeps %{srpm}
if [[ $? != 0 ]]; then echo 'srpm install failed: %{srpm}' >&amp;2; exit 1 ; fi

# rebuild srpm
rpmbuild -bs --target %{arch} --define='dist el%{version}' %{spec} 
if [[ $? != 0 ]]; then echo 'srpm build failed: %{spec}' >&amp;2; exit 1; fi

# build rpm
rpmbuild -ba --target %{arch} --define='dist .el%{version}' %{spec}
if [[ $? != 0 ]]; then echo 'rpm build failed: %{spec}' >&amp;2; exit 1; fi

# validate rpm
for f in `find %{build-dir}/RPMS -type f -name "*.rpm"`; do 
  rpmlint $f
  if [[ $? == 66 ]]; then 
    echo 'rpmlint badness threshold exceeded: $f' >&amp;2; exit 1; 
  fi
done
</script>
<xi:include href="../common/deploy.xml" 
            xpointer="xpointer(/*/post/*[@id='check-kernel'])"/>
</post>

<xi:include href="../common/deploy.xml" 
            xpointer="xpointer(/*/*[name()!='config-rpms' and
                                    name()!='kickstart' and
                                    name()!='trigger' and
                                    name()!='install' and
                                    name()!='post'])"/>
</publish>

</repo>
