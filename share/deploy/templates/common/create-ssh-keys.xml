<?xml version="1.0" encoding="utf-8"?>
<script id='create-ssh-keys' type='pre-install'>
#!/bin/bash
set -e

# create ssh key
if ! [ -f %{data-dir}/id_rsa ]; then
  [ -d %{data-dir} ] || mkdir %{data-dir}
  cd %{data-dir}

  # create key
  ssh-keygen -q -t rsa -b 2048 -f id_rsa -N ""

  #strip user@hostname from public key
  cat id_rsa.pub | cut -d' ' -f 1-2 > id_rsa.pub.new
  mv id_rsa.pub.new id_rsa.pub

  # create pem encoded public key
  openssl req -x509 -days 365 -new -key id_rsa -out id_rsa.pem -batch

  cd - >/dev/null

  # remove existing key from build machine known_hosts
  [ -f /root/.ssh/known_hosts ] &amp;&amp; sed -i '/%{fqdn}/d' /root/.ssh/known_hosts || :
fi
</script>
