<config-rpm id="rsnapshot-ssh-config">
<requires>rsnapshot-ssh-config</requires>
<script type='post'>
user="rsnapshot"
sshdir=/home/rsnapshot-server/.ssh
pubkey="<xi:include href="%{rsnapshot-server-ssh-pubkey}" parse="text"/>"
if [[ ! `grep "$user" /etc/passwd` ]]; then
  useradd $user -p $1$mosey$.eyqf8u8JbMJQi.9H1.d60
fi
if [ ! -d $sshdir ]; then
  mkdir $sshdir
fi
if [[ ! -e $sshdir/authorized_keys ]] || \
   [[ ! `grep "$pubkey" $sshdir/authorized_keys` ]]; then
  sed "*.remote-backup@www.deployproject.org/d" $sshdir/authorized_keys
  echo $pubkey >> $sshdir/authorized_keys
fi
chown -R $user:$user $sshdir
chmod 700 $sshdir
chmod 600 $sshdir/authorized_keys
</script>
</config-rpm>
