<?xml version="1.0" encoding="utf-8"?>
<xml xmlns:xi="http://www.w3.org/2001/XInclude">

<xi:include href="%{templates-dir}/deploy/deploy-developer-config.xml"/> 
<xi:include href="%{templates-dir}/deploy/deploy-remote-client-config.xml"/> 

<script id='test-deploy-developer' verbose='true' type='post' comes-after='install-config' comes-before='poweroff'>

<macro id='mercurial-workspace'>/root/workspace</macro>
<macro id='oss'>centos rhel</macro>
<macro id='versions'>6</macro>
<macro id='archs'>i386 x86_64</macro>

#!/bin/sh

# test script for deploy test machines

# environment
rootdir=%{mercurial-workspace}
export PYTHONPATH=$rootdir/%{tag}:$PYTHONPATH

echo Running tests on host `hostname`
echo
echo

# default values
[ -z "$arch"     ] &amp;&amp; arch=`uname -i`
[ -z "$loglevel" ] &amp;&amp; loglevel=1

echo Cloning deploy '('tag=%{tag}')'

[ -e $rootdir ] || mkdir $rootdir

rm -rf $rootdir/%{tag}
hg clone --quiet --rev "%{tag}" https://www.deployproject.org/hg/public/deploy $rootdir/%{tag}

# testing
pwd=$(pwd)
lastmd5="/var/cache/%{tag}/md5sum"
cd $rootdir/%{tag}
make md5
if ! [ -f $lastmd5 ] || ! diff md5sum $lastmd5 > /dev/null; then
  cd $rootdir/%{tag}/dtest
  for os in %{oss}; do
  for version in %{versions}; do
  for arch in %{archs}; do
    echo
    echo ===================================================
    echo Testing repo builds for os $os-$version-$arch...
    python run.py --os $os \
                  --version $version \
                  --arch $arch \
                  --share-path $rootdir/%{tag}/share/deploy \
                  --log-level $loglevel \
                  --macro "deploy-host:192.168.123.1"
                  $modules
    mv test.log test.log.$os-$version-$arch
  done
  done
  done
  cd - &amp;> /dev/null
  cp md5sum `dirname $lastmd5`
  cd $pwd
fi
</script>
</xml>
