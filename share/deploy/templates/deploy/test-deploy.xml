<?xml version="1.0" encoding="utf-8"?>
<xml xmlns:xi="http://www.w3.org/2001/XInclude">

<config-rpm id='test-deploy-config'>
<requires>deploy-developer-config</requires>
</config-rpm>

<input-script>
#!/bin/sh
# track the latest repository revision so that tests run each time the 
# repository changes

set -e
file=%{input-dir}/hgtip
hgtip_curr=`hg identify https://www.deployproject.org/hg/public/deploy`
hgtip_last=`[ -f $file ] &amp;&amp; cat $file || echo ''`
if [[ $hgtip_curr != $hgtip_last ]]; then
  echo $hgtip_curr > $file 
fi
</input-script>

<script id='test-deploy' verbose='true' type='post' comes-after='install-config' comes-before='poweroff'>

<macro id='mercurial-workspace'>/root/workspace</macro>
<macro id='oss'>centos rhel</macro>
<macro id='versions'>5 6</macro>
<macro id='archs'>i386 x86_64</macro>

#!/bin/sh

# test script for deploy test machines

# environment
rootdir=%{mercurial-workspace}
export PYTHONPATH=$rootdir/deploy:$PYTHONPATH

echo Running tests on host `hostname`
echo
echo

# default values
[ -z "$arch"     ] &amp;&amp; arch=`uname -i`
[ -z "$loglevel" ] &amp;&amp; loglevel=1
[ -z "$deployver"  ] &amp;&amp; deployver=tip

echo Cloning deploy '('tag=$deployver')'

[ -e $rootdir ] || mkdir $rootdir

rm -rf $rootdir/deploy
hg clone --quiet --rev "$deployver" https://www.deployproject.org/hg/public/deploy $rootdir/deploy

# testing
cd $rootdir/deploy/dtest
for os in %{oss}; do
for version in %{versions}; do
for arch in %{archs}; do
  echo
  echo ===================================================
  echo Testing repo builds for os $os-$version-$arch...
  python run.py --os $os \
                --version $version \
                --arch $arch \
                --share-path $rootdir/deploy/share/deploy \
                --log-level $loglevel \
                --macro "deploy-host:192.168.123.1"
                $modules
  mv test.log test.log.$os-$version-$arch
done
done
done
</script>
</xml>
