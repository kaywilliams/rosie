<?xml version="1.0" encoding="utf-8"?>
<script id='conditional-test-remove-custom-pkgs' type='post' verbose='true' 
        comes-before="check-kernel, poweroff" modules='test-install'> 
<macro id='test-remove-custom-pkgs'>false</macro>
#!/bin/sh

# test custom package removal
if [[ %{test-remove-custom-pkgs} == true ]]; then
  for p in %{custom-pkgs}; do
    output=$(yum -y --disableplugin sync remove $p 2>&amp;1)
    if [ $? != 0 ] || echo $output | grep -q "scriptlet failure"; then
      FAIL=true
      while read -r line
      do
        protected=$(echo $line | sed -n \
          's/^Error: Trying to remove "\([^"]*\)", which is protected.*/\1/p')
        if [ -n "$protected" ]; then
          echo "Note: unable to perform a test removal of '$p', which is needed for protected package '$protected'"
          FAIL=false
          break
        fi
      done &lt;&lt;&lt; "$output"
      if [[ $FAIL == true ]]; then
        echo "An error occurred removing '$p'" >&amp;2
        exit 1
      fi
    fi
  done
fi
</script>
