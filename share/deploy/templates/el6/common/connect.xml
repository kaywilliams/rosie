<script type='activate' id='connect' comes-after='activate'>
#!/usr/bin/python

import socket
import sys
import time
import traceback 

# test if a connection can be established, retry for 120 seconds to allow
# time for the remote system to boot and the ssh daemon to get started.

timeout = 120
sleep = 2
total = 0
try:
  s = socket.socket()
  while True:
    try:
      s.connect(('%{ssh-host}', 22))
      break 
    except (socket.gaierror, socket.error), e:
      # Catch "Name or service not known", "Connection timed out", 
      # "Connection refused", or "No route to host" errors
      if e[0] in [ -2, 110, 111, 113]:
        if total >= timeout:
          msg = ('unable to connect to host in %s second timeout: \n%s'
                  % (timeout, e))
          sys.stderr.write(msg)
          sys.exit(1)
        else:
          time.sleep(sleep)
          total += sleep
      else:
        sys.stderr.write(traceback.format_exc())
        sys.exit(1)
except Exception:
  sys.stderr.write(traceback.format_exc())
  sys.exit(1)
finally:
  s.close
</script>
