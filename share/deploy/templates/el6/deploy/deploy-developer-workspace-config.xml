<?xml version="1.0" encoding="UTF-8"?>
<config-rpm id='deploy-developer-workspace-config'>
<requires>mercurial</requires>

<macro id="mercurial-workspace">/root/workspace</macro>
<macro id="tag">deploy</macro>
<macro id="python-site-packages-path">/usr/lib/python2.6/site-packages</macro>

<script type='post'>
file='/etc/deploy/deploy.conf'

# create the base file if needed
if ! [ -f $file ]; then
mkdir -p $(dirname $file)
echo "&lt;deploy>
&lt;/deploy>" > $file
fi

# add elements as needed
lib="&lt;lib-path>%{mercurial-workspace}/%{tag}&lt;/lib-path>"
share="&lt;share-path>%{mercurial-workspace}/%{tag}/share/deploy&lt;/share-path>"
tmpl="&lt;templates-path>%{mercurial-workspace}/%{tag}/share/deploy/templates&lt;/templates-path>"

for elem in $lib $share $tmpl; do 
  if ! grep -q $elem $file; then
    sed -i '/&lt;\/deploy>/d' $file
    echo $elem >> $file
    echo "&lt;/deploy>" >> $file
  fi
done

# create symlink to binary
ln -sf %{mercurial-workspace}/%{tag}/bin/deploy /usr/bin/deploy

# create symlink to python libraries
rm -f %{python-site-packages-path}/deploy
ln -s %{mercurial-workspace}/%{tag}/deploy %{python-site-packages-path}/deploy 
</script>

<script type="postun">
if [ $1 == 0 ]; then
  rm -f /usr/bin/deploy
  rm -f %{python-site-packages-path}/deploy
fi
</script>

<script type='post'>
# clone deploy repository
if [ ! -e %{mercurial-workspace} ];
  then /bin/mkdir %{mercurial-workspace};
fi

if [[ ! %{tag} = deploy ]]; then 
  args="-r %{tag}"
fi
 
if [ ! -d %{mercurial-workspace}/%{tag} ]; then
  cd %{mercurial-workspace}
  hg clone https://www.deployproject.org/hg/public/deploy $args
  cd -
fi
</script>
</config-rpm>
