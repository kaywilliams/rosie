<?xml version="1.0" encoding="utf-8"?>
<script id='activate' type='activate'>
#!/usr/bin/python

import libvirt
import os
import sys

from deploy.util import pps
file = pps.path(os.path.dirname(os.path.abspath(__file__)))/ 'libvirt-%{module}'

if file.exists():
  guestname = file.read_text().strip().replace('guestname=', '')
else:
  sys.stderr.write("unable to determine guestname - %s does not exist\n" % file)
  sys.exit(1)

connection = libvirt.open('qemu:///system')
try: #vm exists?
  vm = connection.lookupByName(guestname)
except libvirt.libvirtError:
  sys.stderr.write("vm does not exist\n")
  sys.exit(1)
state = vm.state(0)[0]
if state == 1: # vm is active
  sys.exit(0) 
elif state == 3: # vm is paused 
  if vm.resume() == 0: 
    sys.exit(0) #resume succeded
  else:
    sys.stderr.write("vm is paused and failed to resume\n")
    sys.exit(1)
elif vm.create() == 0: # vm is inactive
  sys.exit(0)
else:
  sys.stderr.write("vm is inactive and failed to start\n")
  sys.exit(1)
</script>
