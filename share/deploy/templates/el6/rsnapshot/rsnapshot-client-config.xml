<config-rpm id='rsnapshot-client-config'>
<!--
To use this template, first create the rsnapshot server (see
rsnapshot-server.definition). Then create a config-rpm macro in your client
definition that looks something like the following. 

The rsnapshot-client-config template configures the authorized_keys file on the
client to accept ssh connections from the server. You may also need to
configure the client firewall to allow inbound ssh connections from the server.

<config-rpm id='rsnapshot-client-config'>
<macro id='rsnapshot-server-ssh-pubkey-text'><include href="rsnapshot-server-%{os}-%{version}-%{arch}/id_rsa.pub" parse="text"/></macro>

<include
    href="%{templates-dir}/%{norm-os}/rsnapshot/rsnapshot-client-config.xml"
    xpath="./*"/>

<script type='post'>
# script that configures the firewall to accept ssh connections from the server
...
</script>
</config-rpm>
-->

<!-- everything here and below is part of the template -->
<requires>rsync</requires>

<!-- add backup server to authorized_keys -->
<script type='post'>
sshdir=/root/.ssh
authkeys=$sshdir/authorized_keys
pubkey=`echo "%{rsnapshot-server-ssh-pubkey-text}" | tr -d '\n'`

[[ -d $sshdir ]] || mkdir $sshdir
[[ -f $authkeys ]] || touch $authkeys
grep -q "$pubkey" $authkeys || echo $pubkey >> $authkeys

chown -R root:root $sshdir
chmod 700 $sshdir
chmod 600 $authkeys
</script>
</config-rpm>
