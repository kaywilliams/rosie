<?xml version="1.0" encoding="utf-8"?>
<script id='install' type='install'>
#!/bin/bash
set -e

echo "creating %{hostname}"
/usr/bin/azure vm create \
  "%{hostname}" \
  5112500ae3b842c8b9c604889f8753c3__OpenLogic-CentOS-63APR20130415 \
  "%{user}" \
  "%{password}" \
  --location "West US" \
  --ssh \
  --ssh-cert "%{data-dir}/id_rsa.pem"

%{wait}

opts="
-o StrictHostKeyChecking=no 
"

echo "installing ssh key"
ssh -i %{data-dir}/id_rsa $opts %{user}@%{ssh-host} -tt "echo %{password} | sudo -S /bin/bash -c 'mkdir /root/.ssh; chmod 700 /root/.ssh; echo \"%{build-host-pubkey}\" > /root/.ssh/authorized_keys; chmod 600 /root/.ssh/authorized_keys; restorecon -R /root/.ssh'"

echo "downloading release package"
scp $opts %{localroot}/repo.conf root@$ipaddress:/etc/yum.repos.d/%{name}.repo  
ssh $opts root@$ipaddress yum -q -y install %{name}-release

echo "allowing kernel updates"
ssh $opts root@%{ssh-host} "sed -i 's/^exclude=kernel\*/# exclude=kernel*/g' /etc/yum.conf"
</script>
