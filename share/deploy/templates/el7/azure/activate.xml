<?xml version="1.0" encoding="utf-8"?>
<script id='activate' type='activate' verbose='true'>
#!/usr/bin/python

import sys
from azure.mgmt.compute import ComputeManagementClient

sys.path.insert(0, "%{templates-dir}/%{norm-os}/azure")

from azure_lib import *

client_id = '%{azure-client-id}'
secret = '%{azure-client-secret}'
tenant = '%{azure-tenant-id}'
subscription_id = '%{azure-subscription-id}'
resource_group_name = '%{azure-resource-group-name}'
fqdn = '%{fqdn}'

credentials = get_credentials(client_id, secret, tenant)
compute_client = ComputeManagementClient(credentials, subscription_id)

# vm exists?
try:
  compute_client.virtual_machines.get(resource_group_name, fqdn)
except CloudError as e:
  if e.error == 'AzureError: ResourceNotFound':
    sys.exit(3)
</script>
