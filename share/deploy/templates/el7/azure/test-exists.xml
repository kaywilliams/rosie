<?xml version="1.0" encoding="utf-8"?>
<script id='test-exists' type='test-exists'>
#!/usr/bin/python

import sys
from azure.mgmt.compute import ComputeManagementClient

sys.path.insert(0, "%{templates-dir}/%{norm-os}/azure")

from azure_lib import *

DELETE_VOLUME = True 
SSH_HOST_KEY_FILE = '%{ssh-host-key-file}'
SSH_HOST = '%{ssh-host}'

client_id = '%{azure-client-id}'
secret = '%{azure-client-secret}'
tenant = '%{azure-tenant-id}'
subscription_id = '%{azure-subscription-id}'
resource_group_name = '%{azure-resource-group-name}'

credentials = get_credentials(client_id, secret, tenant)
compute_client = ComputeManagementClient(credentials, subscription_id)

# error if server not found 
try:
  compute_client.virtual_machines.get(resource_group_name, '%{hostname}')
except CloudError as e:
  if any(x in str(e.error) for x in 
        ('ResourceNotFound', 'ResourceGroupNotFound')):
    sys.exit(3)
  else:
    raise e
</script>
