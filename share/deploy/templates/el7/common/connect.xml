<script type='activate' id='connect' comes-after='activate'>
#!/usr/bin/python

import socket
import sys
import time

# test if a connection can be established, retry for 120 seconds to allow
# time for the remote system to boot and the ssh daemon to get started.

timeout = 120
sleep = 2
total = 0
try:
  s = socket.socket()
  while True:
    try:
      s.connect(('%{ssh-host}', 22))
      break 
    except socket.error, e:
      # Catch only "Name or service not known", "Connection refused", or 
      # "No route to host" errors
      if e[0] in [ -2, 111, 113]:
        if total >= timeout:
          raise
        else:
          time.sleep(sleep)
          total += sleep
      else:
        sys.stderr.write(str(e))
        sys.exit(1)
finally:
  s.close
</script>
