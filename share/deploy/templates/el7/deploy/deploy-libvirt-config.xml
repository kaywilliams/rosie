<?xml version="1.0" encoding="UTF-8"?>
<config-rpm id="deploy-libvirt-config" xmlns:xi="http://www.w3.org/2001/XInclude">
<summary>configures libvirt local dns resolution</summary>
<license>GPLv2</license>

<macro id='libvirt-network-domain'>deploy</macro>
<macro id='libvirt-network-bridge-name'>virbrdpl</macro>

<requires>NetworkManager</requires>
<!--el6.4 fixed a security issue that breaks local dns resolution, requiring
     an update to dnsmasq. see
     http://lists.thekelleys.org.uk/pipermail/dnsmasq-discuss/2013q1/006761.html
     The updated dnsmasq rpm is available from the deploy package repository.
     -->
<requires>dnsmasq >= 2.66.13</requires>
<requires>libvirt</requires>
<requires>qemu-kvm</requires>
<requires>virt-install</requires>
<requires>virt-manager</requires>
<requires>virt-viewer</requires>
<requires>/sbin/ifconfig</requires>
<requires>/usr/bin/virsh</requires>

<files destdir="/etc/modprobe.d" destname="nested-kvm.conf" content="text">
options kvm-intel nested=y
</files>

<files destdir="/etc/NetworkManager/dispatcher.d" 
       destname="99-deploy-libvirt-config" mode="755" content="text">
#!/bin/sh

# execute deploy-libvirt-config script as a background process to work
# around the nm-dispatcher 3 second timeout issue.

/sbin/deploy-libvirt-config &amp;
</files>

<files destdir="/sbin" destname="deploy-libvirt-config"
       mode="755" content="text">
#!/bin/sh

# Create/update deploy virtual network

# ensure libvirt is running
/bin/systemctl start libvirtd.service

working="%{installdir}"
libvirt="/etc/libvirt/qemu/networks"

# Assign IP address for virtual network
xml=`virsh net-dumpxml deploy 2>/dev/null`
ipaddr=`echo $xml | sed -n "s/.*&lt;ip address=[\"\']\([0-9.]\+\).*/\1/p"`
ipstart=`echo $xml | sed -n "s/.*&lt;range start=[\"\']\([0-9.]\+\).*/\1/p"`
ipend=`echo $xml | sed -n "s/.*&lt;range.* end=[\"\']\([0-9.]\+\).*/\1/p"`

if [[ "$ipaddr" = "" || "$ipstart" = "" || "$ipend" = "" ]]; then 
  start=123
  end=255
  success=false
  for i in `seq $start $end`; do 
    ipaddr="192.168.$i.1"
    ipstart="192.168.$i.2"
    ipend="192.168.$i.254"
    if ! (/sbin/ifconfig | grep 192.168.$i ) >/dev/null ; then
      success=true
      break
    fi
  done
  if [[ $success = false ]]; then
    logger -t "deploy-libvirt-config" -s "ERROR: Unable to assign IP address for virtual network in the range '192.168.$start.1' to '192.168.$end.1'. Please change the IP address of an existing virtual network and try again."
    exit 1
  fi
fi

# Create/update deploy.xml

/bin/cp -f $working/deploy.tmpl $working/deploy.xml
sed -i "s/%ipaddr/$ipaddr/g" $working/deploy.xml
sed -i "s/%ipstart/$ipstart/g" $working/deploy.xml
sed -i "s/%ipend/$ipend/g" $working/deploy.xml

[ -e $working/deploy.last ] || touch $working/deploy.last
if ! diff $working/deploy.xml $working/deploy.last &amp;> /dev/null; then
  if ! ps aux | grep "[/]sbin/anaconda"; then
    if virsh net-info deploy &amp;>/dev/null; then
      virsh net-destroy deploy &amp;>/dev/null || true
      virsh net-undefine deploy >/dev/null
    fi
  fi
  /bin/cp -f $working/deploy.xml $libvirt/deploy.xml
fi

# define the network
virsh net-info deploy
if ! virsh net-info deploy &amp;> /dev/null; then
  virsh net-define $libvirt/deploy.xml >/dev/null
fi

# start it 
if ! ps aux | grep "[/]sbin/anaconda"; then
  if ! virsh net-info deploy | grep Active | grep -q yes; then
    virsh net-start deploy >/dev/null
  fi
fi

# set it to autostart
if ! virsh net-info deploy | grep Autostart | grep -q yes; then
  virsh net-autostart deploy >/dev/null
fi
/bin/mv -f $working/deploy.xml $working/deploy.last

# make dnsmasq the first nameserver in resolv.conf
[[ `grep "$ipaddr" /etc/resolv.conf` ]] || \
sed -i "1,/^nameserver/ {/^nameserver/i\
nameserver $ipaddr
}" /etc/resolv.conf

# add search statement to resolv.conf if it doesn't exist
[[ `grep "^search" /etc/resolv.conf` ]] || \
sed -i "1,/^nameserver $ipaddr/ {/^nameserver/i\
search %{libvirt-network-domain}
}" /etc/resolv.conf

# add virtual network to search statement if it doesn't exist
[[ `grep -P "^search .* %{libvirt-network-domain}( |$)" /etc/resolv.conf` ]] || \
sed -i "/search /s/$/ %{libvirt-network-domain}/" /etc/resolv.conf

# save ipaddr for use during uninstall
echo -e "ipaddr=$ipaddr" > %{installdir}/uninstall.info
</files>

<files destdir="%{installdir}" destname="deploy.tmpl" content="text">
&lt;network>
  &lt;name>deploy&lt;/name>
  &lt;domain name="%{libvirt-network-domain}"/>
  &lt;bridge name="%{libvirt-network-bridge-name}" />
  &lt;forward/>
  &lt;ip address="%ipaddr" netmask="255.255.255.0">
    &lt;dhcp>
      &lt;range start="%ipstart" end="%ipend" />
    &lt;/dhcp>
  &lt;/ip>
&lt;/network>
</files>

<trigger type="triggerin" trigger="NetworkManager">
#!/bin/sh
set -e

file=/etc/systemd/system/dbus-org.freedesktop.nm-dispatcher.service

if ! grep -q "RemainAfterExit" $file; then
echo "
# modified by deploy-libvirt-config to work around 3 second timeout
# see https://bugzilla.redhat.com/show_bug.cgi?id=1048345

[Service]
RemainAfterExit=yes
" >> $file
fi
</trigger>

<script type="post">
# run dispatcher.d script
if ! ps aux | grep "[/]sbin/anaconda"; then
  #ensure our modified dispatcher service is started
  /bin/systemctl restart NetworkManager-dispatcher.service

  # run the script
  /etc/NetworkManager/dispatcher.d/99-deploy-libvirt-config
fi

# ensure consistent ip forwarding
# wish we could do this using a sysctl.d script, but NetworkManager seems to
# overwrite the value each time it is restarted, without calling sysctl.d
# scripts.
text="net.ipv4.ip_forward"
file="/etc/sysctl.conf"
if [[ `grep "$text" $file` = *0* ]] ; then
  sed -i "s/^$text.*/$text = 1/" $file # modify file 
  /bin/cp -r $file %{installdir}       # backup file for use during cleanup
  if ! ps aux | grep "[/]sbin/anaconda"; then
    sysctl -q -p                       # update sysctl
  fi
fi
</script>

<script type='postun'>
if [[ $1 = 0 ]]; then
  if find `dirname %{installdir}` -name '99-deploy-libvirt-config' | \
     grep -v %{installdir} ; then 
    # revert /etc/sysctl.conf if necessary 
    text="net.ipv4.ip_forward"
    file="/etc/sysctl.conf"
    if [ -f %{installdir}/sysctl.conf ] ; then
      if diff $file %{installdir}/sysctl.conf ; then 
        /bin/cp -f %{installdir}/sysctl.conf $file
        sed -i "s/^$text.*/$text = 0/" $file # modify file 
        sysctl -q -p                         # update sysctl
        /bin/rm -f %{installdir}/sysctl.conf # remove backup file 
      fi
    fi
    if virsh net-info deploy >/dev/null 2>&amp;1; then
      virsh net-destroy deploy >/dev/null 2>&amp;1 || true
      virsh net-undefine deploy >/dev/null
    fi

    # resolv.conf cleanup
    source %{installdir}/uninstall.info #provides $ipaddr 
    sed -i "/nameserver $ipaddr/d" /etc/resolv.conf
    sed -i "s/\(^search .*\) %{libvirt-network-domain}/\1/g" /etc/resolv.conf
  fi
fi
</script>
</config-rpm>
