<?xml version="1.0" encoding="UTF-8"?>
<config-rpm xmlns:xi="http://www.w3.org/2001/XInclude" 
            id='deploy-remote-host-config'>
<description>
Configures a system to serve as a deploy-host for remote client requests.
</description>

<!-- containing definitions must also include an update script in their
     test and publish elements, e.g.
     <xi:include href="%{templates-dir}/%{norm-os}/common/update.xml/>
     -->

<macro id='deploy-client-pub-keydir'>%{data-dir}/deploy-client-pubkeys</macro>
<prep-script>
#!/bin/sh
set -e
# create the folder and a dummy file so deploy doesn't complain about missing
# files
[ -d %{deploy-client-pub-keydir} ] || \
(mkdir -p %{deploy-client-pub-keydir} ; \
 touch %{deploy-client-pub-keydir}/.pubkey-placeholder)
</prep-script>

<requires>openssh</requires>
<requires>openssh-clients</requires>
<requires>/usr/sbin/sshd</requires>

<!-- copy client pubkeys to host -->
<files>%{deploy-client-pub-keydir}</files>
<files mode='750'>%{templates-dir}/%{norm-os}/common/ssh-install-pubkey.sh</files>

<!-- install client pubkeys on host -->
<script type='post'>
#!/bin/sh
set -e
for f in $(find %{install-dir}/files/$(%{basename deploy-client-pub-keydir}) -name "*.pub") ; do
  %{install-dir}/files/ssh-install-pubkey.sh $f /root/.ssh/authorized_keys
done
</script>

</config-rpm>
