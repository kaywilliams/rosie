<?xml version="1.0" encoding="UTF-8"?>
<config-rpm id='drupal-config'>
<description>downloads core drupal files</description>

<macro id='drupal-version'>8.1.10</macro>

<macro id='download-dir'>/root/Downloads</macro>
<macro id='drupal-download-dir'>%{download-dir}/drupal8</macro>
<macro id='drupal-web-dir'>/var/www/html/drupal</macro>
<macro id='drupal-user'>apache</macro>
<macro id='drupal-sbin-dir'>/usr/sbin</macro>

<macro id='drupal-admin-password'>Test1!</macro>
<macro id='drupal-admin-mail'>admin@example.com</macro>
<macro id='drupal-site-mail'>admin@example.com</macro>
<macro id='drupal-site-name'>drupal</macro>
<macro id='drupal-sites-dir'>%{drupal-web-dir}/sites</macro>
<macro id='drupal-default-sites-dir'>%{drupal-sites-dir}/default</macro>
<macro id='drupal-settings-file'>%{drupal-default-sites-dir}/settings.php</macro>
<macro id='drupal-files-dir'>%{drupal-default-sites-dir}/files</macro>
<macro id='drupal-mods-dir'>%{drupal-web-dir}/modules</macro>
<macro id='drupal-db-name'>%{drupal-site-name}</macro>
<macro id='drupal-db-type'>mariadb</macro><!-- pgsql, mariadb or sqlite -->
<macro id='drupal-db-user'>drupal</macro>
<macro id='drupal-db-password'>%{drupal-admin-password}</macro>

<include href="%{templates-dir}/%{norm-os}/common/repos.xml"
         xpath="./repo[@id='epel']"/>
%{%{os}-repos}
<macro id="centos-repos"/>
<macro id="rhel-repos">
<!-- needed for php-mbstring  -->
<include href="%{templates-dir}/%{norm-os}/common/repos.xml" 
         xpath="./repo[@id='rhel-optional']"/>
</macro>

<repo id='webtatic'>
<baseurl>https://repo.webtatic.com/yum/%{norm-os}/%{arch}/</baseurl>
<gpgkey>https://mirror.webtatic.com/yum/RPM-GPG-KEY-webtatic-%{norm-os}</gpgkey>
</repo>

<requires>php55w</requires>
<requires>php55w-opcache</requires>
<requires>php55w-mbstring</requires>
<requires>php55w-gd</requires>
<requires>php55w-xml</requires>
<requires>php55w-pear</requires>
<requires>php55w-fpm</requires>
<requires>/usr/sbin/sendmail</requires>
<requires>/usr/sbin/postdrop</requires>

<!-- include httpd.conf so that macros are resolved -->
<files destdir='/etc/httpd/conf' destname='httpd.conf' content='text'>
<include href='etc/httpd/conf/httpd.conf' parse='text'/>
</files>

<files destdir="/usr/sbin" destname="drupal-update-trusted-host-patterns"
       mode="750" content="text">
#!/bin/sh

file=${1:-%{drupal-settings-file}} 

# remove existing trusted_host_patterns
sed -i '/^#-----TRUSTED HOST PATTERNS-----#$/,$d' $file

# add trusted_host_patterns
h=$(echo "`hostname` `hostname -I`" | sed "s/\./\\\./g")
cat &lt;&lt;EOT >> $file
#-----TRUSTED HOST PATTERNS-----#
\$settings['trusted_host_patterns'] = array(
  '^`echo $h | sed "s/ /$',\n  '^/g"`$',
);
EOT
</files>

<files destdir="/usr/sbin" destname="drupal-enable-local-settings"
       mode="750" content="text">
#!/bin/sh

file=${1:-%{drupal-settings-file}} 

match="^if (file_exists(__DIR__ . '/settings.local.php'))"
string="
if (file_exists(__DIR__ . '/settings.local.php')) {
  include __DIR__ . '/settings.local.php';
}"

if ! grep -q "$match" $file; then
  echo "$string" >> $file
fi
</files>

<script type='post'>
set -x

# variables
download_file=drupal-%{drupal-version}.tar.gz

# download latest version
mkdir -p %{download-dir}
cd %{download-dir}
if ! [ -f $download_file ]; then
  wget -q https://ftp.drupal.org/files/projects/$download_file
  tar -zxpf $download_file
  rm -rf %{drupal-download-dir}
  mv -f drupal-%{drupal-version} %{drupal-download-dir}
fi

# cleanup old download files
find %{download-dir} -maxdepth 1 -name "drupal-*.tar.gz*" ! -name "$download_file" -delete

# make drupal webroot
if ! [ -d %{drupal-web-dir} ]; then

  # copy files
  cp -a %{drupal-download-dir} %{drupal-web-dir}
  restorecon -R %{drupal-web-dir}

  # create settings file
  cp -p %{drupal-default-sites-dir}/default.settings.php %{drupal-settings-file}

  # create files dir and set permissions
  mkdir -p %{drupal-files-dir}
  chown -R %{drupal-user}:%{drupal-user} %{drupal-files-dir} 
  chcon -R -t httpd_sys_content_rw_t %{drupal-files-dir}
  chmod -R 750 %{drupal-files-dir}
fi
</script>
</config-rpm>
