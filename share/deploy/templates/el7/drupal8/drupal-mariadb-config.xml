<?xml version="1.0" encoding="UTF-8"?>
<config-rpm id='drupal-mariadb-config'>

<macro id='drupal-db-su'>root</macro>
<macro id='create-drupal-database-script'>
  # create drupal database
  mysql -u %{drupal-db-su} -p%{mariadb-password} \
        -e "create database if not exists %{drupal-site-name}"
  mysql -u %{drupal-db-su} -p%{mariadb-password} \
        -e "grant all on %{drupal-site-name}.* TO '%{drupal-db-user}'@'localhost' identified by '%{drupal-db-password}'"
  
  # restart mariadb service
  systemctl restart mariadb
</macro>
<macro id='drupal-site-install-script'>
  %{create-drupal-database-script}

  # use drush to complete site install
  /usr/bin/env PHP_OPTIONS="-d sendmail_path=`which true`" \
  drush -y -q si standard \
    --account-pass=%{drupal-admin-password} \
    --account-mail=%{drupal-admin-mail} \
    --db-url=mysql://%{drupal-db-user}:%{drupal-db-password}@localhost/%{drupal-site-name} \
    --db-su=%{drupal-db-su} \
    --site-mail=%{drupal-site-mail} \
    --site-name=%{drupal-site-name}
</macro>

<requires>php55w-mysql</requires>
<requires>%{drupal-db-type}-server-config</requires>

<!-- drupal config -->
<include href="%{templates-dir}/%{norm-os}/drupal8/drupal-config.xml"
         xpath="./*"/>

<include href="%{templates-dir}/%{norm-os}/drupal8/drupal-config-script.xml"/>

</config-rpm>
