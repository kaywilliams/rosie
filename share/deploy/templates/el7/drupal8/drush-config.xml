<config-rpm id='drush-config'>
<macro id='composer-dir'>/usr/share/composer</macro>
<macro id='drush-error-wrapper-name'>drush-error-wrapper</macro>
<macro id='drush-error-wrapper'>%{drupal-sbin-dir}/%{drush-error-wrapper-name}</macro>
<macro id='drushrc-update-name'>drushrc-update</macro>
<macro id='drushrc-update'>%{drupal-sbin-dir}/%{drushrc-update-name}</macro>

<requires>php-composer-config</requires>
<requires>tar</requires>

<files destdir="%{drupal-sbin-dir}" destname="%{drush-error-wrapper-name}"
       mode="750" content="text">
#!/usr/bin/sh

# wraps drush to exit with error if output contains the string "error"

params="$@"

cd %{drupal-web-dir}

if drush $params 2>&amp;1 | grep -qi error; then
  echo "Error running 'drush $params'" >&amp;2
  drush $params >&amp;2
  exit 1
fi
</files>

<files destdir="%{drupal-sbin-dir}" destname="%{drushrc-update-name}" mode='750'
       content='text'>
#!/usr/bin/sh

# creates and updates a drushrc file; requires a string value as a parameter

file=%{drupal-default-sites-dir}/drushrc.php
string="$1"

if ! [ -f $file ] ; then
  cp /usr/share/composer/vendor/drush/drush/examples/example.drushrc.php $file
fi

if ! grep --fixed-strings "$string" $file; then
  echo "$string" >> $file
fi
</files>

<script type='post'>
%{composer-dir}/composer.phar -q global require drush/drush:8.* \
  --working-dir %{composer-dir}
ln -sf %{composer-dir}/vendor/bin/drush /usr/bin/drush 
</script>
</config-rpm>
