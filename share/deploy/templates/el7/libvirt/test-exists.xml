<?xml version="1.0" encoding="utf-8"?>
<script id='test-exists' type='test-exists'>
#!/usr/bin/python

import libvirt
import os
import sys

from deploy.util import pps
file = pps.path('%{libvirt-guestname-file}')
legacy_file=pps.path('/var/lib/deploy/deploy-client/%{id}/libvirt-%{module}')

if file.exists():
  guestname = file.read_text().strip().replace('guestname=', '')
elif legacy_file.exists():
  legacy_file.move(file)
  guestname = file.read_text().strip().replace('guestname=', '')
else:
  sys.stderr.write("guestname file '$file' does not exist\n")
  sys.exit(3)

connection = libvirt.open('qemu:///system')
try: #vm exists?
  vm = connection.lookupByName(guestname)
except libvirt.libvirtError:
  sys.stderr.write("vm does not exist\n")
  sys.exit(3)
</script>
