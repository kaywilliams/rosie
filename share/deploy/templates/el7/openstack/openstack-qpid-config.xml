<?xml version="1.0" encoding="UTF-8"?>
<config-rpm id="openstack-qpid-config">
<description>
Congifures a messaging queue service for openstack.
</description>

<macro id='qpid-host'>127.0.0.1</macro>

<!-- package requires -->
<requires>python-qpid</requires>
<requires>qpid-cpp-server</requires>
<requires>memcached</requires>
<requires>openstack-utils</requires>
<requires>NetworkManager</requires>
<requires>systemd-units</requires>

<script type='post'>
#!/bin/sh
set -e

# Disable Qpid authentication by setting the value of the auth configuration key to no in the /etc/qpid/qpidd.conf file.
file=/etc/qpidd.conf
sed -i "/auth=yes/d" $file # eliminate auth=yes if found
grep -q "auth=no" $file || echo "auth=no" >> $file

# Start the NetworkManager-wait-online service to ensure qpid starts after
# network interfaces are completely up. See
# http://qpid.2158936.n2.nabble.com/qpid-listening-socket-after-reboot-td7584509.html
# for additional information
/bin/systemctl -q enable NetworkManager-wait-online.service
if ! ps aux | grep "[/]sbin/anaconda"; then
  /bin/systemctl start NetworkManager-wait-online.service
fi

# Start the Qpid message broker.
/bin/systemctl -q enable qpidd
if ! ps aux | grep "[/]sbin/anaconda"; then
  /bin/systemctl reload-or-restart qpidd
fi
</script>
</config-rpm>
