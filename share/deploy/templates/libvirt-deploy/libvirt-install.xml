<?xml version="1.0" encoding="utf-8"?>
<script id='virt-install' type='install'>
#!/bin/bash
set -e

# installs virtual machines from within either normal or cron user environments
# cron environment requires use of the graphics parameter to virt-install, as
# well as the while loop to wait for installation to complete

# libvirt hostnames must be less than 50 characters
guestname=%{hostname}
if [[ ${#guestname} &gt; 50 ]]; then
  while :
  index=1
  do
    guestname="${guestname:0:48}_$index"
    echo $guestname
    virsh dominfo $guestname || break  # if guestname available, break from loop
  done
fi

# install machine
/usr/sbin/virt-install \
  --name $guestname \
  --arch %{arch} \
  --ram 1000 \
  --disk path=/var/lib/libvirt/images/$guestname.img,size=%{file-size} \
  --graphics vnc \
  --network network=deploy \
  --location %{os-url} \
  --extra-args "%{boot-options} ks=%{url}/ks.cfg" \
  --noreboot

# wait for install to complete and machine to shutdown
while [[ `/usr/bin/virsh domstate $guestname` = "running" ]]; do
  sleep 2 
done
</script>
