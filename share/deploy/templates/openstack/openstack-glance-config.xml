<?xml version="1.0" encoding="UTF-8"?>
<config-rpm id="openstack-glance-config"
            xmlns:xi="http://www.w3.org/2001/XInclude">
<description>
Configures an image service for openstack.
</description>

<!-- default values -->
<macro id='glance-host'>127.0.0.1</macro>
<macro id='glance-db-password' type='script'>
#!/usr/bin/python
import uuid
print uuid.uuid4().hex[:16]
</macro>
<macro id='glance-user-password' type='script'>
#!/usr/bin/python
import uuid
print uuid.uuid4().hex[:16]
</macro>

<!-- package requires -->
<requires>openstack-glance</requires>
<requires>openstack-keystone-config</requires>
<requires>openstack-mysql-config</requires>

<script type='post'>
# modify glance-api.conf
cmd="openstack-config --set /etc/glance/glance-api.conf"
$cmd DEFAULT sql_connection \
     mysql://glance:%{glance-db-password}@%{glance-host}/glance
$cmd keystone_authtoken auth_host %{keystone-host}
$cmd keystone_authtoken admin_user glance
$cmd keystone_authtoken admin_tenant_name service
$cmd keystone_authtoken admin_password %{glance-user-password}

# modify glance-registry.conf
cmd="openstack-config --set /etc/glance/glance-registry.conf"
$cmd DEFAULT sql_connection \
     mysql://glance:%{glance-db-password}@%{glance-host}/glance
$cmd keystone_authtoken auth_host %{keystone-host}
$cmd keystone_authtoken admin_user glance
$cmd keystone_authtoken admin_tenant_name service
$cmd keystone_authtoken admin_password %{glance-user-password}

# create database
if ! mysql -u root -p%{mysql-password} -e "show databases like 'glance'" |\
  grep glance; then
  openstack-db --yes --init --service glance --rootpw "%{mysql-password}" \
               --password "%{glance-db-password}"
fi

# create glance user in keystone
export OS_USERNAME=admin
export OS_TENANT_NAME=admin
export OS_PASSWORD=%{keystone-admin-password}
export OS_AUTH_URL=http://%{keystone-host}:35357/v2.0/

if ! keystone user-get glance &amp;>/dev/null; then
  keystone user-create --name glance --pass %{glance-user-password}
  keystone user-role-add --user glance --tenant service --role admin

  # create glance service and api endpoint entries
  keystone service-create --name glance --type=image \
           --description "Glance Image Service"
  serviceid=$(keystone service-get glance | sed -n 's/|.*id.*| \(.*\) |/\1/p')
  keystone endpoint-create \
           --service-id=$serviceid \
           --publicurl=http://%{glance-host}:9292 \
           --internalurl=http://%{glance-host}:9292 \
           --adminurl=http://%{glance-host}:9292
fi

unset OS_USERNAME OS_TENANT_NAME OS_PASSWORD OS_AUTH_URL

# start glance service
service openstack-glance-api restart > /dev/null
service openstack-glance-registry restart > /dev/null
chkconfig openstack-glance-api on
chkconfig openstack-glance-registry on
</script>

<files destdir='root' destname='keystonerc_admin' mode='600' content='text'>
export OS_USERNAME=admin
export OS_TENANT_NAME=admin
export OS_PASSWORD=%{keystone-admin-password}
export OS_AUTH_URL=http://%{keystone-host}:35357/v2.0/
export PS1='[\\u@\\h \\W(keystone_admin)]\\$ '
</files>
</config-rpm>
