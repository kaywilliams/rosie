<?xml version="1.0" encoding="UTF-8"?>
<config-rpm id="openstack-nova-network-config"
            xmlns:xi="http://www.w3.org/2001/XInclude">
<description>
Configures nova-networking services for openstack
</description>

<macro id='nova-network-host'>127.0.0.1</macro>
<macro id='nova-network-privif'>lo</macro>
<macro id='nova-network-pubif'>eth0</macro>
<macro id='nova-network-bridge-ipaddr'>192.168.32.1</macro>
<macro id='nova-network-bridge-netmask'>255.255.252.0</macro>
<macro id='nova-network-fixedrange'>192.168.32.0/22</macro>
<macro id='nova-network-floatrange'>10.3.4.0/22</macro>
<macro id='nova-network-defaultfloatingpool'>nova</macro>
<macro id='nova-network-autoassignfloatingip'>n</macro>

<requires>openstack-nova-network</requires>
<requires>openstack-nova-config</requires>
<requires>openstack-keystone-config</requires>
<requires>bc</requires> <!-- to calculate network size -->

<script type='post'>
# allow vms to access public network interface
ip link set %{nova-network-pubif} promisc on

# calculate some variables
routing_prefix=$(echo %{nova-network-fixedrange} | cut -d/ -f2)
network_size=$(echo "2^(32-$routing_prefix)" | bc)

# update nova.conf
openstack-config --set /etc/nova/nova.conf DEFAULT network_manager \
   nova.network.manager.FlatDHCPManager
openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver \
   nova.virt.libvirt.firewall.IptablesFirewallDriver
openstack-config --set /etc/nova/nova.conf DEFAULT network_size \
   $network_size 
openstack-config --set /etc/nova/nova.conf DEFAULT allow_same_net_traffic \
   True 
openstack-config --set /etc/nova/nova.conf DEFAULT multi_host False 
openstack-config --set /etc/nova/nova.conf DEFAULT send_arp_for_ha True
openstack-config --set /etc/nova/nova.conf DEFAULT share_dhcp_address True
openstack-config --set /etc/nova/nova.conf DEFAULT force_dhcp_release True
openstack-config --set /etc/nova/nova.conf DEFAULT flat_interface \
   %{nova-network-pubif}
openstack-config --set /etc/nova/nova.conf DEFAULT flat_network_bridge br100
openstack-config --set /etc/nova/nova.conf DEFAULT public_interface \
   %{nova-network-pubif}
 
# start nova-network service
service openstack-nova-network restart > /dev/null
chkconfig openstack-nova-network on

# create bridge network
export OS_USERNAME=admin
export OS_TENANT_NAME=admin
export OS_PASSWORD=%{keystone-admin-password}
export OS_AUTH_URL=http://%{keystone-host}:35357/v2.0/

if ! nova-manage network list | grep -q '%{nova-network-fixedrange}'; then
  nova-manage network create private \
    --fixed_range_v4=%{nova-network-fixedrange} \
    --bridge_interface=br100
fi

unset OS_USERNAME OS_TENANT_NAME OS_PASSWORD OS_AUTH_URL
</script>

<files destdir='/etc/sysconfig/network-scripts' destname='ifcfg-br100'
       content='text'>
DEVICE=br100
TYPE=Bridge
ONBOOT=yes
DELAY=0
BOOTPROTO=static
IPADDR=%{nova-network-bridge-ipaddr}
NETMASK=%{nova-network-bridge-netmask}
</files>
</config-rpm>
